---
title: "Taxonomomy Validation Visualizations, Climate Smart Communities"
author: "Joe Skufca"
date:  "2022-03-23"
output: html_notebook
---

Preliminar visualiations of taxonomy usage attempts by the team to work towards validating the vehicle, analyzing Climate Smart Commutities.

## Setup

```{r}
library(tidyverse)
library(janitor)
library(here)
library(plotly)
library(readxl)
```

## Load data

First usage of template performed by the group is aggregated into a single excel file, with each individual rater using the template, with their ratings recorded on a different sheet in an excel file.

```{r}
filename=here("data","taxonomy_csc.xlsx")
```

The file is quite complicated.  Let's understand that file.

```{r}
sheets=excel_sheets(filename)
```

Let's try to read a particular sheet correctly:

```{r}
this_person=sheets[1]
read_sheet=function(this_person){
     shps=rep(c("sustainable","holistic","planning","systems"),times=c(4,5,4,4))
df1=read_excel(filename,sheet=this_person, 
               range = "C9:I28",col_names = FALSE) %>%
     select(1,3,4,6,7) %>% 
     rename(dimension=...1,
            response=...3,
            resp_indicator=...4,
            degree_best=...6,
            degree_indicator=...7) %>% drop_na(dimension) %>%
     mutate(rater=this_person,shps=shps) 
}

df2=map_dfr(sheets[c(1:2,4,5,6)],read_sheet) %>%
     mutate(response=factor(response,
                            levels = c("No","Yes - Could/Should","Yes - Must/Required")))



```

```{r}
df2 %>% ggplot(aes(x=rater,y=dimension,fill=degree_best))+geom_tile()
```

```{r}
df3=df2 %>% select(dimension,rater,degree_best) %>%
     pivot_wider(names_from = rater,values_from = degree_best)
```

```{r}
library(heatmaply)
df3 %>% select(-dimension) %>% 
     heatmaply::heatmaply(x=.,labRow=df3$dimension,cellnote=.,dendrogram="none",
                          plot_method = "plotly",
                          main = "Climate Smart Community, Degree of Best Practices")
```

```{r}
df4=df2 %>% select(dimension,rater,response) %>%
     pivot_wider(names_from = rater,values_from = response)

df2 %>% select(dimension,rater,response) %>% 
     mutate(response=as.numeric(response)) %>%
     pivot_wider(names_from = rater,values_from = response) %>%
     select(-dimension) %>% heatmaply(x=.,labRow=df3$dimension,cellnote=.,dendrogram="none",
                          plot_method = "plotly",
                                      main = "Climate Smart, Response")
```

### Aggregating by shps dimension

```{r}
dfa=df2 %>% mutate(response=as.numeric(response)) %>%
     group_by(shps,rater) %>%
     summarise(response=mean(response),degree_best=mean(degree_best)) %>% 
     ungroup() %>% 
     mutate(shps=ordered(shps,levels=c("sustainable","holistic","planning","systems")))
```

```{r}
shps=c("sustainable","holistic","planning","systems")
dfa %>% select(shps,rater,response) %>% 
     pivot_wider(names_from = rater,values_from = response) %>%
     select(-shps) %>% heatmaply(x=.,labRow=shps,   cellnote=.,dendrogram="none",
                          plot_method = "plotly",
                                      main = "Climate Smart, Response")
```
```{r}

dfa %>% select(shps,rater,degree_best) %>% 
     pivot_wider(names_from = rater,values_from = degree_best) %>%
     select(-shps) %>% heatmaply(x=.,labRow=shps,   cellnote=.,dendrogram="none",
                          plot_method = "plotly",
                                      main = "Climate Smart, best practices")
```
